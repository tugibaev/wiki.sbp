# Отмена оплаты/возврат

Отмена (он же возврат) возможна только для проведенных платежей. Если заказ сформирован, но не оплачен используется операция аннулирования (чтобы его не смогли оплатить случайно).

| Параметр | Значение |
|----------|----------|
| scope токена | `qr/order.cancel` |
| URL | `https://mc.api.sberbank.ru/prod/qr/order/v3/cancel` |

Пример запроса на возврат:
``` json
{
    "rq_uid": "7e51733655004694871fc4feb0618a0c",
    "rq_tm": "2023-09-24T15:12:58Z",
    "order_id": "fd0241e27be9401aa709e4f7aad87eb8",
    "operation_id": "A3267042237426060000020011080701",
    "auth_code": "951258",
    "id_qr": "AD100041695S7RT69D5R9C86C1M3EV5O",
    "tid": "29525577",
    "cancel_operation_sum": 1,
    "operation_currency": "643"
}
```
Пример успешного ответа от Сбера:

``` json
{
    "rq_tm": "2023-09-24T15:17:47Z",
    "operation_date_time": "2023-09-24T18:18:02Z",
    "operation_type": "REFUND",
    "sbp_operation_params": {
        "sbp_cancel_operation_id": "A32671518022040B0000000011080701",
        "sbp_merchant_name": "Exclusive_SBP"
    },
    "operation_currency": "643",
    "tid": "29525577",
    "auth_code": "661397",
    "rrn": "326721348088",
    "order_status": "PAID",
    "operation_sum": 1,
    "id_qr": "Undefined",
    "operation_id": "3066746cc281468fa0dd5c729b66cc12",
    "error_code": "000000",
    "rq_uid": "53fb82783be7481084a801a3cadf5fb6",
    "order_id": "fd0241e27be9401aa709e4f7aad87eb8"
}
```

Пример ошибки от Сбера:

``` json
{
    "rq_tm": "2023-09-24T15:25:25Z",
    "id_qr": "Undefined",
    "operation_sum": 0,
    "error_description": "AMOUNT_TOO_LARGE: Сумма отмены в рамках заказа больше суммы оригинальной\t",
    "error_code": "070000",
    "rq_uid": "4d2b2c49cd2c48129acb19f2c31d15dc",
    "order_id": "fd0241e27be9401aa709e4f7aad87eb8",
    "tid": "29525577"
}
```

Пример уведомления о проведении возврата:

``` json
{
    "sbpOperationParams": {
        "sbpOperationId": "A32680755411910E0000020011080701",
        "sbpPayerId": "*********6600"
    },
    "authCode": "000000",
    "orderId": "18faaa9ee4ac4794a8cf6b685d681cd0",
    "clientName": "Артем Ахтямович Т.",
    "partnerOrderNumber": "0000100000049",
    "rqUid": "dacd57767e67403e9cdae8a9ebf57e5b",
    "rqTm": "2023-09-25T07:58:41Z",
    "idQR": "AD10002J6D31UCKR93OOP59NJ8290FK0",
    "operationSum": 1,
    "tid": "29525577",
    "orderState": "PAID",
    "responseCode": "-1",
    "operationDateTime": "2023-09-25T10:58:41Z",
    "operationId": "AF41641CB3164202AF22682B60CBB077",
    "operationType": "REFUND",
    "operationCurrency": "643",
    "memberId": "00003505"
}
```

Это минимальный набор обязательных параметров согласно спецификации.

Необходимо обратить внимание на параметр `cancel_operation_sum`, который указывает на сумму возврата. Сумма не может быть больше суммы оплаты (это контролируется со стороны Сбера) и может быть **только один возврат по оплате.**
Цитата ответа от службы поддержки:

> Возврат по QR СБП в СББОЛ можно выполнить только один (полный или частичный), если был выполнен частичный возврат и требуется дополнительно вернуть средства – рекомендуй воспользоваться альтернативным способом (наличные, POS терминал, API). По API ограничений нет на количество возвратов (возвраты можно проводить до полного возврата суммы). Возвраты выполняются только в МП СББОЛ или API, если у клиента нет доступа – рекомендуй воспользоваться альтернативным способом (наличные, POS терминал, API).
